<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sales Reports Dashboard | AmoraLise</title>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;700&family=Montserrat:wght@300;400;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        :root {
            --primary-dark: #1a1a2e;
            --primary-light: #16213e;
            --accent-gold: #d4af37;
            --accent-gold-light: #e6c872;
            --accent-light: #e6d5b8;
            --text-light: #f1f1f1;
            --text-dark: #333;
            --gradient-bg: linear-gradient(135deg, #f9f5f0 0%, #f0ede5 100%);
            --shadow: 0 4px 20px rgba(0,0,0,0.15);
            --transition: all 0.3s ease;
            --chart-bg: rgba(255, 255, 255, 0.95);
            --chart-grid: #e0e0e0;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Montserrat', sans-serif;
            background: var(--gradient-bg);
            color: var(--text-dark);
            line-height: 1.6;
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1440px;
            margin: 0 auto;
            padding: 30px;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 40px;
            padding: 20px;
            background: var(--chart-bg);
            border-radius: 12px;
            box-shadow: var(--shadow);
            flex-wrap: wrap;
        }

        .logo {
            font-family: 'Playfair Display', serif;
            font-size: 2.2rem;
            font-weight: 700;
            background: linear-gradient(45deg, var(--primary-dark), var(--accent-gold));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .header-buttons {
            display: flex;
            gap: 20px;
            align-items: center;
        }

        .back-btn, .logout-btn {
            background: linear-gradient(45deg, var(--primary-light), var(--primary-dark));
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: var(--transition);
            display: flex;
            align-items: center;
            gap: 10px;
            box-shadow: var(--shadow);
        }

        .back-btn:hover, .logout-btn:hover {
            background: var(--accent-gold);
            color: var(--primary-dark);
            transform: translateY(-2px);
        }

        .section {
            background: var(--chart-bg);
            padding: 30px;
            border-radius: 12px;
            box-shadow: var(--shadow);
            border: none;
            transition: transform 0.3s ease;
            margin-bottom: 30px;
        }

        .section:hover {
            transform: translateY(-5px);
        }

        .summary-title {
            font-family: 'Playfair Display', serif;
            color: var(--primary-dark);
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 2px solid var(--accent-gold);
            font-size: 1.8rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .summary-title i {
            color: var(--accent-gold);
        }

        .sales-charts {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .chart-container {
            background: var(--chart-bg);
            padding: 20px;
            border-radius: 12px;
            box-shadow: var(--shadow);
            text-align: center;
            transition: var(--transition);
            position: relative;
        }

        .chart-container:hover {
            transform: translateY(-5px);
        }

        .chart-container h3 {
            font-size: 1.3rem;
            color: var(--primary-dark);
            margin-bottom: 15px;
            font-weight: 600;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .chart-container h3 i {
            color: var(--accent-gold);
            font-size: 1.2rem;
        }

        .chart-container canvas {
            max-width: 100%;
            height: 220px !important;
        }

        .chart-value {
            font-size: 2rem;
            color: var(--accent-gold);
            font-weight: 700;
            margin-top: 15px;
            font-family: 'Playfair Display', serif;
            opacity: 0;
            animation: fadeIn 0.5s ease forwards;
        }

        .no-data {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: #666;
            font-style: italic;
            font-size: 1rem;
        }

        @keyframes fadeIn {
            to { opacity: 1; }
        }

        @media (max-width: 768px) {
            .container {
                padding: 20px;
            }

            .header {
                flex-direction: column;
                align-items: flex-start;
                padding: 15px;
            }

            .header-buttons {
                width: 100%;
                justify-content: flex-end;
                margin-top: 20px;
            }

            .sales-charts {
                grid-template-columns: 1fr;
            }

            .chart-container canvas {
                height: 180px !important;
            }

            .chart-value {
                font-size: 1.8rem;
            }
        }

        @media (max-width: 480px) {
            .logo {
                font-size: 1.8rem;
            }

            .summary-title {
                font-size: 1.5rem;
            }

            .chart-container h3 {
                font-size: 1.1rem;
            }

            .chart-container h3 i {
                font-size: 1rem;
            }

            .chart-value {
                font-size: 1.5rem;
            }

            .chart-container canvas {
                height: 150px !important;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="logo">
                <span>AMORALISE</span>
            </div>
            <div class="header-buttons">
                <button id="backToDashboardBtn" class="back-btn">
                    <i class="fas fa-arrow-left"></i> BACK TO DASHBOARD
                </button>
                <button id="logoutBtn" class="logout-btn">
                    <i class="fas fa-sign-out-alt"></i> LOGOUT
                </button>
            </div>
        </div>

        <div id="admin" class="section active">
            <h2 class="summary-title"><i class="fas fa-chart-line"></i> Sales Reports</h2>
            <div class="sales-charts" id="salesCharts">
                <div class="chart-container">
                    <h3><i class="fas fa-money-bill-wave"></i> Total Sales Over Time</h3>
                    <canvas id="totalSalesChart"></canvas>
                    <p class="chart-value" id="totalSalesValue">₱0.00</p>
                </div>
                <div class="chart-container">
                    <h3><i class="fas fa-shopping-cart"></i> Total Orders</h3>
                    <canvas id="totalOrdersChart"></canvas>
                    <p class="chart-value" id="totalOrdersValue">0</p>
                </div>
                <div class="chart-container">
                    <h3><i class="fas fa-coins"></i> Average Order Value</h3>
                    <canvas id="avgOrderValueChart"></canvas>
                    <p class="chart-value" id="avgOrderValueValue">₱0.00</p>
                </div>
                <div class="chart-container">
                    <h3><i class="fas fa-boxes"></i> Total Items Sold</h3>
                    <canvas id="totalItemsSoldChart"></canvas>
                    <p class="chart-value" id="totalItemsSoldValue">0</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Initialize data from localStorage
        let auditLog = JSON.parse(localStorage.getItem('auditLog')) || [];

        // Normalize auditLog
        auditLog = auditLog.map(log => {
            let items = log.items || [];
            let totalItems = 0;

            // Handle items field
            if (typeof items === 'string') {
                try {
                    items = JSON.parse(items);
                    totalItems = Array.isArray(items) ? items.length : items.split(',').filter(item => item.trim()).length;
                } catch (e) {
                    totalItems = items.split(',').filter(item => item.trim()).length;
                }
            } else if (Array.isArray(items)) {
                totalItems = items.length;
            }

            return {
                timestamp: log.timestamp || new Date().toISOString(),
                orderId: log.orderId || 'Unknown',
                items: typeof log.items === 'string' ? log.items : JSON.stringify(log.items || []),
                totalItems: totalItems,
                total: parseFloat(log.total) || 0
            };
        });

        // Process data for charts
        function prepareChartData(logs) {
            const salesByDate = {};
            logs.forEach(log => {
                const date = new Date(log.timestamp).toISOString().split('T')[0];
                if (!salesByDate[date]) {
                    salesByDate[date] = { total: 0, orders: 0, items: 0 };
                }
                salesByDate[date].total += log.total;
                salesByDate[date].orders += 1;
                salesByDate[date].items += log.totalItems;
            });

            const dates = Object.keys(salesByDate).sort();
            const totalSalesData = dates.map(date => salesByDate[date].total.toFixed(2));
            const totalOrdersData = dates.map(date => salesByDate[date].orders);
            const totalItemsData = dates.map(date => salesByDate[date].items);

            const totalSales = logs.reduce((sum, log) => sum + log.total, 0).toFixed(2);
            const totalOrders = logs.length;
            const avgOrderValue = totalOrders > 0 ? (totalSales / totalOrders).toFixed(2) : '0.00';
            const totalItemsSold = logs.reduce((sum, log) => sum + log.totalItems, 0);

            return {
                dates,
                totalSalesData,
                totalOrdersData,
                totalItemsData,
                totalSales,
                totalOrders,
                avgOrderValue,
                totalItemsSold
            };
        }

        // Render charts
        function renderCharts(logs) {
            const data = prepareChartData(logs);
            const noDataMessage = `<div class="no-data">No data available</div>`;

            // Chart.js configuration
            const commonOptions = {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: true,
                        position: 'top',
                        labels: {
                            font: { family: 'Montserrat', size: 12, weight: '600' },
                            color: '#333'
                        }
                    },
                    tooltip: {
                        enabled: true,
                        backgroundColor: 'rgba(26, 26, 46, 0.9)',
                        titleFont: { family: 'Montserrat', size: 14 },
                        bodyFont: { family: 'Montserrat', size: 12 },
                        padding: 10,
                        cornerRadius: 8,
                        callbacks: {
                            label: function(context) {
                                let label = context.dataset.label || '';
                                if (label) label += ': ';
                                if (context.parsed.y !== null) {
                                    if (label.includes('Sales') || label.includes('Value')) {
                                        label += `₱${parseFloat(context.parsed.y).toFixed(2)}`;
                                    } else {
                                        label += context.parsed.y;
                                    }
                                }
                                return label;
                            }
                        }
                    }
                },
                animation: {
                    duration: 1000,
                    easing: 'easeOutQuart'
                }
            };

            // Total Sales Over Time (Line Chart)
            const totalSalesCanvas = document.getElementById('totalSalesChart');
            if (data.dates.length === 0) {
                totalSalesCanvas.parentElement.innerHTML += noDataMessage;
            } else {
                new Chart(totalSalesCanvas, {
                    type: 'line',
                    data: {
                        labels: data.dates,
                        datasets: [{
                            label: 'Total Sales',
                            data: data.totalSalesData,
                            borderColor: '#d4af37',
                            backgroundColor: ctx => {
                                const gradient = ctx.chart.ctx.createLinearGradient(0, 0, 0, 220);
                                gradient.addColorStop(0, 'rgba(212, 175, 55, 0.4)');
                                gradient.addColorStop(1, 'rgba(212, 175, 55, 0)');
                                return gradient;
                            },
                            fill: true,
                            tension: 0.4,
                            pointBackgroundColor: '#d4af37',
                            pointBorderColor: '#fff',
                            pointBorderWidth: 2,
                            pointRadius: 5,
                            pointHoverRadius: 7
                        }]
                    },
                    options: {
                        ...commonOptions,
                        scales: {
                            y: {
                                beginAtZero: true,
                                title: { display: true, text: 'Sales (₱)', font: { family: 'Montserrat', size: 12 } },
                                grid: { color: 'rgba(224, 224, 224, 0.5)' },
                                ticks: { font: { family: 'Montserrat', size: 10 } }
                            },
                            x: {
                                title: { display: true, text: 'Date', font: { family: 'Montserrat', size: 12 } },
                                grid: { display: false },
                                ticks: { font: { family: 'Montserrat', size: 10 }, maxRotation: 45, minRotation: 45 }
                            }
                        }
                    }
                });
            }
            document.getElementById('totalSalesValue').textContent = `₱${data.totalSales}`;

            // Total Orders (Doughnut Chart)
            const totalOrdersCanvas = document.getElementById('totalOrdersChart');
            if (data.totalOrders === 0) {
                totalOrdersCanvas.parentElement.innerHTML += noDataMessage;
            } else {
                new Chart(totalOrdersCanvas, {
                    type: 'doughnut',
                    data: {
                        labels: ['Total Orders'],
                        datasets: [{
                            label: 'Orders',
                            data: [data.totalOrders, 1], // Second value for visual effect
                            backgroundColor: ['#d4af37', 'rgba(224, 224, 224, 0.2)'],
                            borderColor: ['#d4af37', 'rgba(224, 224, 224, 0.2)'],
                            borderWidth: 1
                        }]
                    },
                    options: {
                        ...commonOptions,
                        cutout: '70%',
                        plugins: {
                            ...commonOptions.plugins,
                            legend: { display: false }
                        }
                    }
                });
            }
            document.getElementById('totalOrdersValue').textContent = data.totalOrders;

            // Average Order Value (Doughnut Chart)
            const avgOrderValueCanvas = document.getElementById('avgOrderValueChart');
            if (data.avgOrderValue === '0.00') {
                avgOrderValueCanvas.parentElement.innerHTML += noDataMessage;
            } else {
                new Chart(avgOrderValueCanvas, {
                    type: 'doughnut',
                    data: {
                        labels: ['Average Order Value'],
                        datasets: [{
                            label: 'Avg Value (₱)',
                            data: [data.avgOrderValue, 1], // Second value for visual effect
                            backgroundColor: ['#d4af37', 'rgba(224, 224, 224, 0.2)'],
                            borderColor: ['#d4af37', 'rgba(224, 224, 224, 0.2)'],
                            borderWidth: 1
                        }]
                    },
                    options: {
                        ...commonOptions,
                        cutout: '70%',
                        plugins: {
                            ...commonOptions.plugins,
                            legend: { display: false }
                        }
                    }
                });
            }
            document.getElementById('avgOrderValueValue').textContent = `₱${data.avgOrderValue}`;

            // Total Items Sold (Doughnut Chart)
            const totalItemsSoldCanvas = document.getElementById('totalItemsSoldChart');
            if (data.totalItemsSold === 0) {
                totalItemsSoldCanvas.parentElement.innerHTML += noDataMessage;
            } else {
                new Chart(totalItemsSoldCanvas, {
                    type: 'doughnut',
                    data: {
                        labels: ['Total Items Sold'],
                        datasets: [{
                            label: 'Items',
                            data: [data.totalItemsSold, 1], // Second value for visual effect
                            backgroundColor: ['#d4af37', 'rgba(224, 224, 224, 0.2)'],
                            borderColor: ['#d4af37', 'rgba(224, 224, 224, 0.2)'],
                            borderWidth: 1
                        }]
                    },
                    options: {
                        ...commonOptions,
                        cutout: '70%',
                        plugins: {
                            ...commonOptions.plugins,
                            legend: { display: false }
                        }
                    }
                });
            }
            document.getElementById('totalItemsSoldValue').textContent = data.totalItemsSold;
        }

        // Back to Dashboard functionality
        document.getElementById('backToDashboardBtn').addEventListener('click', function() {
            window.location.href = 'admin-dashboard.html';
        });

        // Logout functionality
        document.getElementById('logoutBtn').addEventListener('click', function() {
            localStorage.clear();
            window.location.href = 'front-page.html';
        });

        // Initialize
        renderCharts(auditLog);
    </script>
</body>
</html>